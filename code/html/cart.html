<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
    <script type="text/javascript" src="../js/jquery-3.4.1.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        table th,
        table td,
        input {
            text-align: center;
        }

        table #checkAll {
            width: 120px;
        }
        .table1{
            width:1200px;
            margin:auto;
            border:1px solid #0cb95f;
            margin-top: 20px;
            height:60px;
            position: relative;
        }
        .table2{
            width:1200px;
            margin:auto;
            border:1px solid #0cb95f;
            border-top:none;

        }
        .table2 img{
            width:120px;
            height:120px;
            border:1px solid #ccc;
        }
        .table3{
            width:1200px;
            height:60px;
            border:1px solid #0cb95f;
            margin:auto;
            border-top:none;
        }
        table #checkAll label {
            cursor: pointer;
            padding-left: 10px;
        }

        table .check label {
            cursor: pointer;
        }
        table input[type="text"] {
            width: 50px;
            overflow: hidden;
        }

        table span {
            display: inline-block;
            width: 20px;
            background: #8C8C8C;
            margin: 0px 5px;
            color: #FFFFFF;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <table class="table1">
        <tr>
            <th id="checkAll"><label><input type="checkbox" class="checked" />全选</label><button>删除</button></th>
            <th style="width:260px;">商品名称</th>
            <th style="width:100px;">库存</th>
            <th>商品价格(元)</th>
            <th style="width:100px;">数目</th>
            <th style="width:200px;">小计(元)</th>
            <th style="width:120px;">操作</th>
        </tr>
    </table>
    <div class="main">
        <!-- <tr>
            <td class="check"><label><input type="checkbox" checked /></label></td>
            <td>商品名称2</td>
            <td class="price">12.50</td>
            <td><span class="sub">-</span><input type="text" value="1" class="num"/><span class="add">+</span></td>
            <td class="subtotal">12.50</td>
            <td class="del"><button>删除</button></td>
        </tr>
        <tr>
            <td class="check"><label><input type="checkbox" checked /></label></td>
            <td>商品名称3</td>
            <td class="price">110.40</td>
            <td><span class="sub">-</span><input type="text" value="1" class="num"/><span class="add">+</span></td>
            <td class="subtotal">110.40</td>
            <td class="del"><button>删除</button></td>
        </tr> -->
    </div>
    <table class="table3">
        <tr>
            <td colspan="5" style="text-align: right;">总件数：<i id="numAll"></i>件 &nbsp; &nbsp; 总计：<i
                    id="total"></i>元</td>
        </tr>
    </table>


</body>

</html>

<script>
    $(function () {
        getCatInfo();

        function getCatInfo() {


            $.ajax({
                type: "post",
                url: "../api/cart.php",
                dataType: "json",
                success: function (data) {
                    targetData = data
                    var res = data.map(function (ele) {
                        gd = ele.gid;
                        var html = `<table class="table2">
           <tr>
   <td class="check"style="width:60px;"><label><input type="checkbox" class="check" ${ele.isActive==1 ? "checked" : "" }/></label></td>
   <td style="width:122px; height:122px;"><img src="${ele.tu1}" alt=""></td>
   <td class="td1" style="width:132px; height:122px;">
           <strong class="str">${ele.title}</strong>
           <p>规格:${ele.regular}</p>
   </td>
   <td class="td2" style="width:132px; height:122px;">${ele.kucun}</td>
   <td class="price"style="width:150px; color:red;">${ele.price}</td>
   <td class="td3"style="width:200px;"><span class="sub">-</span><input type="text" value="${ele.num}" class="num"/><span class="add">+</span></td>
   <td class="subtotal" style="width:120px;">${ele.total}</td>
   <td class="del" style="width:120px";><button>删除</button></td>
</tr><table>`
                        return html;
                    }).join("");

                    $(".main").html(res);
                    counts();
                    totalPrice();
                }
            });
        }

        // 全选
        $("#checkAll input").click(function () {
            var flag = $(this).prop("checked");
            if (flag) {
                $(".check label input").prop("checked", true);

                $("#checkAll label").css("background", "url(img/confirm.png) no-repeat center left");
                $(".check label").css("background", "url(img/confirm.png) no-repeat center");

            } else {
                $(".check label input").prop("checked", false);

                $("#checkAll label").css("background", "url(img/confirm_no.png) no-repeat center left");
                $(".check label").css("background", "url(img/confirm_no.png) no-repeat center");
            }
            counts();
            totalPrice();
        });

        //单选
        $(".check input").click(function () {
            var flag = $(this).prop("checked"); //获取当前input的状态
            var CL = $(".check input").length; //列表长度；
            var CH = $(".check input:checked").length; //列表中被选中的长度

            if (flag) {
                $(this).parent("label").css("background", "url(img/confirm.png) no-repeat center");
            } else {
                $(this).parent("label").css("background", "url(img/confirm_no.png) no-repeat center");
            }

            if (CL == CH) {
                $("#checkAll input").prop("checked", true);
                $("#checkAll label").css("background", "url(img/confirm.png) no-repeat center left");
            } else {
                $("#checkAll input").prop("checked", false);
                $("#checkAll label").css("background", "url(img/confirm_no.png) no-repeat center left");
            }
            counts();
            totalPrice();
        })

        //数目加
        $(".main").on( "click",".add",function () {
            var num = $(this).prev().val();
            var price = parseFloat($(this).parent().siblings(".price").text());
            num++;
            $(this).prev().val(num);

            //      小计
          var total = $(this).parent().siblings(".subtotal").text((price * num).toFixed(2));
            var gid = gd;
            $.ajax({
              
                type: "post",
                url: "../api/adt.php",
                data: "gid=" + gid + "&num=" + num ,
                success: function (response) {
                    counts();
                totalPrice();
                }
            });
          
        })
        //数目减
        $(".main").on( "click",".sub",function () {
            var num = $(this).next().val();
            var price = parseFloat($(this).parent().siblings(".price").text());
            num--;
            if (num <= 1) {
                num = 1
            }
            $(this).next().val(num);

            //      小计
            var total =  $(this).parent().siblings(".subtotal").text((price * num).toFixed(2));
            var gid = gd;
            $.ajax({
              
              type: "post",
              url: "../api/jian.php",
              data: "gid=" + gid + "&num=" + num ,
              success: function (response) {
                  counts();
                totalPrice();

              }
          });
        })

        //文本框脱里焦点处理
        $('.num').each(function (i) {
            $(this).blur(function () {
                let p = parseFloat($(this).parents('tr').find(".subtotal").text());
                let c = parseFloat(this.value);
                console.log(p * c);
                $(this).parents('tr').find(".subtotal").text((c * p).toFixed(2));
                counts();
                totalPrice();
            })
        })

        //单行删除
        $(".main").on("click", ".del", function () {
            var gid = gd;
            $.ajax({
                type: "post",
                url: "../api/remove.php",
                data: "gid=" + gid,
                success: function (response) {
                    getCatInfo();
                }
            });
        })

        //全删除
        $("#checkAll button").click(function () {
            var flag = $(this).prev().children().prop("checked");
            //           console.log(flag);
            if (flag) {

                if (confirm("是否确定删除")) {

                    $(".check").parent().remove();
                    var CL = $(".check input").length; //列表长度；

                    if (CL == 0) {
                        $("#checkAll label input").prop("checked", false);
                        $("#checkAll label").css("background",
                            "url(img/confirm_no.png) no-repeat center left");
                    }
                    counts();
                    totalPrice();
                }

            }
        })

        //总价格
        totalPrice();

        function totalPrice() {
            var prices = 0;
            $('.check input:checked').each(function (i) {
                prices += parseFloat($(this).parents("tr").find('.subtotal').text());
            })
            $('#total').text(prices);
        }
        //总数目
        counts();

        function counts() {
            var sum = 0;
            $('.check input:checked').each(function (i) {
                sum += parseInt($(this).parents("tr").find('.num').val());
            })
            $('#numAll').text(sum);
        }

    })
</script>